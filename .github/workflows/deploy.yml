name: Deploy (S3 frontend + EC2 backend)

on:
  push:
    branches: [deploy]

permissions:
  id-token: write   # required for OIDC
  contents: read

jobs:
  changes:
      runs-on: ubuntu-latest
      outputs:
        client: ${{ steps.filter.outputs.client }}
        server: ${{ steps.filter.outputs.server }}
        shared: ${{ steps.filter.outputs.shared }}
      steps:
        - uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Debug SHAs and diff
          run: |
            echo "sha: $GITHUB_SHA"
            echo "before: ${{ github.event.before }}"
            echo "after:  ${{ github.sha }}"
            git --no-pager log --oneline -n 5
            git --no-pager diff --name-only ${{ github.event.before }} ${{ github.sha }} || true

        - id: filter
          uses: dorny/paths-filter@v3
          with:
            base: ${{ github.event.before }}
            ref: ${{ github.sha }} 
            filters: |
              client:
                - 'client/**'
              server:
                - 'server/**'
              shared:
                - 'shared/**'
              workflow:
                - '.github/workflows/**'

  deploy_frontend:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' || needs.changes.outputs.shared == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            client/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      # - name: Install + build frontend
      #   working-directory: client
      #   run: |
      #     npm ci
      #     npm run build

      - name: Build shared (required if client imports built output)
        working-directory: shared
        run: npm ci && npm run build
      
      - name: Install client deps
        working-directory: client
        run: npm ci

      - name: Build frontend
        working-directory: client
        run: npm run build

      - name: Deploy to S3
        run: |
          aws s3 sync client/dist s3://${{ vars.S3_BUCKET }}/ --delete

      # Optional (only if you use CloudFront)
      # - name: Invalidate CloudFront
      #   if: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID != '' }}
      #   run: |
      #     aws cloudfront create-invalidation \
      #       --distribution-id ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }} \
      #       --paths "/*"

  # deploy_backend:
  #   runs-on: ubuntu-latest
  #   needs: deploy_frontend
    # needs: changes
    # if: ${{ needs.changes.outputs.server == 'true' || needs.changes.outputs.shared == 'true' }}
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 20
  #         cache: npm
  #         cache-dependency-path: |
  #           server/package-lock.json

  #     - name: Configure AWS credentials (OIDC)
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
  #         aws-region: ${{ vars.AWS_REGION }}

      # # - name: Install + build backend
      # #   working-directory: server
      # #   run: |
      # #     npm ci
      # #     npm run build

      # - name: Install + build shared
      #   working-directory: shared
      #   run: |
      #     npm ci
      #     npm run build

      # - name: Install backend
      #   working-directory: server
      #   run: npm ci

      # - name: Build backend
      #   working-directory: server
      #   run: npm run build

  #     - name: Create backend artifact
  #       run: |
  #         tar -czf backend.tgz \
  #           server/dist server/package.json server/package-lock.json

  #     - name: Upload artifact to S3 (deployment bucket/prefix)
  #       run: |
  #         aws s3 cp backend.tgz s3://${{ vars.S3_BUCKET }}/_deploy/backend.tgz

  #     - name: Deploy on EC2 via SSM (download + restart)
  #       run: |
  #         aws ssm send-command \
  #           --instance-ids "${{ vars.EC2_INSTANCE_ID }}" \
  #           --document-name "AWS-RunShellScript" \
  #           --comment "Deploy backend" \
  #           --parameters commands='[
  #             "set -euo pipefail",
  #             "sudo mkdir -p /opt/myapp",
  #             "aws s3 cp s3://${{ vars.S3_BUCKET }}/_deploy/backend.tgz /opt/myapp/backend.tgz",
  #             "cd /opt/myapp",
  #             "sudo tar -xzf backend.tgz",
  #             "cd /opt/myapp/server",
  #             "sudo npm ci --omit=dev",
  #             "sudo systemctl restart myapp"
  #           ]'
